<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="css/style.css" />
    <title>Code Avenue</title>
  </head>
  <body>
    <div class="navbar__div" id="nav-placeholder"></div>
    <div id="preloader">
      <div id="loader"></div>
    </div>
    <div class="order__div">
      <div class="order__right-div">
        <h3 class="order__summary-title">Order Summary</h3>
        <div class="order__summary-div" id="order-summary">
          <div class="order__summary-header">
            <img class="order__summary-img" src="" name="course-image" alt="" />
            <h1 class="order__summary-name course-name"></h1>
          </div>
          <div class="order__summary-details">
            <p class="course-name"></p>
            <h4 class="order__summary-detail2" id="course-price">$140</h4>
            <p>Discount</p>
            <p class="order__summary-detail2" id="price-discount">-$139</p>
            <h4>Billed Today</h4>
            <h4 id="billed-today" class="order__summary-detail2">$70</h4>
          </div>
          <div class="order__footer">
            <div class="order__footer-btn-div">
              <button class="order__footer-btn" id="order-now">Buy Now</button>
            </div>
            <div class="order__footer-div">
              <i class="material-icons">lock</i
              ><small class="order__footer-text"
                >All transactions are secure and encrypted.</small
              >
            </div>
          </div>
        </div>
        <div class="order__right-div-p">
          <p class="order__right-div-text">
            By completing this purchase, I agree to Code Avenue's Terms of Use &
            Privacy Policy, and the Terms of Use & Privacy Policy of the course
            platform.
          </p>
        </div>
      </div>
      <div class="order__content">
        <div class="order__get-started">
          <h3 class="order__get-started-title">Get Started</h3>
          <div>
            <p>
              Providing your email allows us to send you everything you need for
              your purchase. Already have an account?
            </p>
          </div>
          <div class="order__get-started-form" id="get-started-form">
            <p>Email Address</p>
            <input type="email" class="order__get-started-email" />
            <div class="order__get-started-footer">
              <input type="checkbox" name="" id="" />
              <small>
                Yes, Code Avenue can email me with promotions and news.
                (optional)
              </small>
            </div>
          </div>
        </div>
        <div class="order__payment" id="payment-form">
          <h3 class="order__payment-title">Payment Information</h3>
          <div class="order__payment-header">
            <i class="material-icons">lock</i>
            <p>All transactions are secure and encrypted.</p>
          </div>

          <div class="order__payment-form">
            <p style="color: rgb(82, 82, 82)">Name on Card</p>
            <input type="text" name="card_holder" value="David Adediji" />
            <p style="color: rgb(82, 82, 82)">Card number</p>
            <input
              type="text"
              name="card_number"
              value="4000000000009995"
              maxlength="16"
            />
            <div class="order__payment-form-flex">
              <div>
                <p style="color: rgb(82, 82, 82)">Expiration Date</p>
                <input type="month" name="card_expiry_date" value="2023-07" />
              </div>

              <div>
                <p style="color: rgb(82, 82, 82)">CVC</p>
                <input type="text" name="cvc" value="634" />
              </div>
            </div>
            <div class="order__payment-footer">
              <input type="checkbox" name="" id="" />
              <small> Save my payment info for future purposes; </small>
            </div>
          </div>
        </div>
        <div class="order__billing" id="billing-form">
          <h3 class="order__billing-title">Billing Address</h3>

          <div class="order__billing-form">
            <p style="color: rgb(82, 82, 82)">Country</p>
            <select name="country" id="">
              <option value="Nigeria">Nigeria</option>
              <option value="United States">United States</option>
              <option value="United Kingdom">United Kingdom</option>
              <option value="Canada">Canada</option>
              <option value="India">India</option>
            </select>

            <p style="color: rgb(82, 82, 82)">Street Address</p>
            <input type="text" />
            <p style="color: rgb(82, 82, 82)">Street Address 2 (Optional)</p>
            <input type="text" />
            <p style="color: rgb(82, 82, 82)">City</p>
            <input type="text" />
            <p style="color: rgb(82, 82, 82)">Postal Code</p>
            <input type="text" />
            <!-- <div class="order__billing-footer">
              <input type="checkbox" name="" id="" />
              <small> Delivery Address same as billing. </small>
            </div> -->
          </div>
        </div>
        <div class="order__reviews">
          <h3 class="order__reviews-title">See what others have to say..</h3>
          <div
            style="display: flex; flex-direction: column; gap: 2rem"
            id="reviews"
          >
            <div class="order__reviews-content">
              <div class="order__reviewer">
                <img class="order__reviewer-img" src="" alt="" />
              </div>
              <div>
                <p class="order__review">
                  John, let me tell you I have been winning the code
                  competitions here in India and excelling in my work and it
                  gives me a great proud to say that you are my teacher. I have
                  purchased every course you have uploaded.
                </p>
                <p>— Johnood Abiola</p>
              </div>
            </div>
          </div>
        </div>
        <div class="order__guarantee">
          <img
            src="https://assets.teachablecdn.com/icons/checkout-badge-1.svg"
            class="order__guarantee-img"
          />
        </div>
      </div>
    </div>
    <script>
      function showPreloader() {
        $("#preloader").show();
      }

      function hidePreloader() {
        $("#preloader").fadeOut("slow", function () {
          $(this).remove();
        });
      }
      function validateCardExpiry(cardExpiry) {
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1; // January is 0
        const [expiryYear, expiryMonth] = cardExpiry.split("-");
        return (
          parseInt(expiryYear) > currentYear ||
          (parseInt(expiryYear) === currentYear &&
            parseInt(expiryMonth) >= currentMonth)
        );
      }

      // Function to validate the CVC number
      function validateCVC(cvc) {
        const cvcRegex = /^[0-9]{3,4}$/;
        return cvcRegex.test(cvc);
      }

      // Function to validate the billing postal code
      function validatePostalCode(postalCode) {
        const postalCodeRegex = /^[A-Za-z0-9]{5}$/;
        return postalCodeRegex.test(postalCode);
      }
      function validateCardNumber(cardNumber) {
        let sum = 0;
        let shouldDouble = false;
        for (let i = cardNumber.length - 1; i >= 0; i--) {
          let digit = parseInt(cardNumber.charAt(i));
          if (shouldDouble) {
            digit *= 2;
            if (digit > 9) {
              digit -= 9;
            }
          }
          sum += digit;
          shouldDouble = !shouldDouble;
        }
        return sum % 10 === 0;
      }
      $(document).ready(function () {
        $("#nav-placeholder").load("nav.html");
        $("#footer-placeholder").load("footer.html");
        // Get the ID of the post from the query string
        const urlParams = new URLSearchParams(window.location.search);
        let courseId = urlParams.get("id");
        let coursePrice = "";

        // Declare the courseId variable outside the success callback function
        $.ajax({
          url: `https://coursefront-prod.herokuapp.com/course_store/courses/${courseId}/reviews/`,
          type: "GET",
          dataType: "json",
          success: function (data) {
            for (review of data) {
              $("#reviews").append(`   <div class="order__reviews-content">
              <div class="order__reviewer">
                <img class="order__reviewer-img" src="" alt="" />
              </div>
              <div>
                <p class="order__review">
                ${review.content}
                </p>
                <p>— ${review.user}</p>
              </div>
            </div>`);
            }
            hidePreloader();
          },
        });

        // Make the first AJAX request
        $.ajax({
          url: `https://coursefront-prod.herokuapp.com/course_store/courses/${courseId}`,
          type: "GET",
          dataType: "json",
          success: function (data) {
            // Assign the value of the course ID from the response to the variable courseId
            courseId = data.id;
            coursePrice = data.price;

            // Use the variable courseId anywhere in the script that you need to access the course ID
            $('img[name="course-image"]').attr("src", data.image);
            $(".course-name").text(data.name);
            $("#course-price").text(`$${data.price}`);
            $("#price-discount").text(`-${data.discount_percentage}%`);
            $("#billed-today").text(
              `$${(
                data.price *
                ((100 - data.discount_percentage) / 100)
              ).toFixed(2)}`
            );

            $("#order-now").click(function () {
              $(this).prop("disabled", true);
              $(this).text("Processing...");
              // Validate email address
              let email = $(".order__get-started-email").val();
              // if (!validateEmail(email)) {
              //   alert("Please enter a valid email address.");
              //   return false;
              // }

              // Validate card details
              // Validate card details
              let cardName = $('input[name="card_holder"]').val();
              let cardNumber = $('input[name="card_number"]').val();
              let cardExp = $('input[name="card_expiry_date"]').val();
              let cardCvc = $('input[name="cvc"]').val();

              if (
                cardName.trim() === "" ||
                cardNumber.trim() === "" ||
                cardExp.trim() === "" ||
                cardCvc.trim() === ""
              ) {
                alert(
                  "Please fill in all the required fields for payment information."
                );
                return false;
              }

              // Validate billing details
              let country = $(".order__billing-form select").val();
              let streetAddr = $(
                '.order__billing-form input[type="text"]:eq(0)'
              ).val();
              let streetAddr2 = $(
                '.order__billing-form input[type="text"]:eq(1)'
              ).val();
              let city = $(
                '.order__billing-form input[type="text"]:eq(2)'
              ).val();
              let postalCode = $(
                '.order__billing-form input[type="text"]:eq(3)'
              ).val();

              if (
                country.trim() === "" ||
                streetAddr.trim() === "" ||
                city.trim() === "" ||
                postalCode.trim() === ""
              ) {
                alert(
                  "Please fill in all the required fields for billing address."
                );
                return false;
              }
              if (!validateCardNumber(cardNumber)) {
                alert("Invalid card number. Please enter a valid card number.");
                return false;
              }

              if (!validateCardExpiry(cardExp)) {
                alert(
                  "Invalid card expiry date. Please enter a valid expiry date."
                );
                return false;
              }

              if (!validateCVC(cardCvc)) {
                alert("Invalid CVC number. Please enter a valid CVC.");
                return false;
              }

              // if (!validatePostalCode(postalCode)) {
              //   alert("Invalid postal code. Please enter a valid postal code.");
              //   return false;
              // }

              // All fields are valid, proceed with the form submission
              // return true;

              // All fields are valid, proceed with purchase
              // alert("Thank you for your purchase!");
              const authToken = localStorage.getItem("auth_token");
              if (!authToken) {
                // Redirect to login page
                sessionStorage.setItem("redirectUrl", window.location.href);
                window.location.href = "/login.html";
                return false;
              } else {
                async function processOrder() {
                  try {
                    const billingAddress = {
                      street_address: streetAddr,
                      city: city,
                      country: country,
                      postal_code: postalCode,
                    };
                    let orderData = {
                      course_id: courseId,
                    };

                    // make the first AJAX request to create the billing address
                    const billingAddressResponse = await fetch(
                      "https://coursefront-prod.herokuapp.com/course_store/billing-address-create/",
                      {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                          Authorization: `Token ${authToken}`,
                        },
                        body: JSON.stringify(billingAddress),
                      }
                    );

                    // check the response from the server and extract the ID of the billing address
                    if (!billingAddressResponse.ok) {
                      throw new Error(
                        `Failed to create billing address: ${billingAddressResponse.statusText}`
                      );
                    }
                    const billingAddressData =
                      await billingAddressResponse.json();
                    const billingAddressId = billingAddressData.id;

                    // make the second AJAX request to create the order
                    const orderResponse = await fetch(
                      "https://coursefront-prod.herokuapp.com/course_store/order/",
                      {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                          Authorization: `Token ${authToken}`,
                        },
                        body: JSON.stringify({
                          ...orderData,
                          ba: billingAddressId,
                        }),
                      }
                    );

                    // check the response from the server and extract the ID of the order
                    if (!orderResponse.ok) {
                      throw new Error(
                        `Failed to create order: ${orderResponse.statusText}`
                      );
                    }
                    orderData = await orderResponse.json();
                    console.log(orderData);
                    const orderId = orderData.id;

                    // make the third AJAX request to create the payment
                    // Parse the card expiry date string into a Date object
                    const cardExpDate = new Date(cardExp + "-01");

                    // Add one day to the card expiry date
                    cardExpDate.setDate(cardExpDate.getDate() + 1);

                    // Convert the date object back to a string in YYYY-MM-DD format
                    const cardExpWithDay = cardExpDate
                      .toISOString()
                      .slice(0, 10);

                    // Pass the updated card expiry date in the request body
                    const paymentResponse = await fetch(
                      "https://coursefront-prod.herokuapp.com/course_store/payments/",
                      {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                          Authorization: `Token ${authToken}`,
                        },
                        body: JSON.stringify({
                          order: orderId,
                          card_holder: cardName,
                          card_number: cardNumber,
                          card_expiry_date: cardExpWithDay,
                          cvc: cardCvc,
                        }),
                      }
                    );

                    // check the response from the server
                    if (!paymentResponse.ok) {
                      throw new Error(
                        `Failed to create payment: ${paymentResponse.statusText}`
                      );
                    }
                    const paymentData = await paymentResponse.json();
                    console.log(paymentData);

                    const paymentId = paymentData.id;

                    const downloadResponse = await fetch(
                      `https://coursefront-prod.herokuapp.com/course_store/download/${paymentId}/`,
                      {
                        method: "GET",
                        headers: {
                          Authorization: `Token ${authToken}`,
                        },
                      }
                    );

                    console.log(downloadResponse);

                    if (downloadResponse.ok) {
                      const fileData = await downloadResponse.blob();
                      const filename = getFilenameFromResponseHeaders(
                        downloadResponse.headers
                      );

                      const downloadLink = document.createElement("a");
                      downloadLink.href = URL.createObjectURL(fileData);
                      downloadLink.download = filename;

                      downloadLink.click();

                      URL.revokeObjectURL(downloadLink.href);

                      // Download successful
                      window.location.href = "courses.html"; // Redirect to courses.html
                    } else {
                      throw new Error(
                        `Failed to download file: ${downloadResponse.statusText}`
                      );
                    }

                    // Function to extract filename from response headers
                    function getFilenameFromResponseHeaders(headers) {
                      const contentDisposition = headers.get(
                        "Content-Disposition"
                      );
                      const filenameRegex =
                        /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                      const matches = filenameRegex.exec(contentDisposition);
                      const filename =
                        matches && matches[1]
                          ? matches[1].replace(/['"]/g, "")
                          : "file";
                      return filename;
                    }
                  } catch (error) {
                    console.error(error);

                    $("#order-now").prop("disabled", false);
                    $("#order-now").text("Buy Now");
                  }
                }

                processOrder();
              }
              return true;
            });

            hidePreloader();
          },
        });
      });

      function validateEmail(email) {
        let re = /\S+@\S+\.\S+/;
        return re.test(email);
      }
    </script>
  </body>
</html>
